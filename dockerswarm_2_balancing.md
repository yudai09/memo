# docker swarmを試す

## 第二回

外部からの通信のバランシングおよび内部の通信のバランシングを試す。

参考：
https://hd35468.wordpress.com/2016/06/27/docker-loadbalancer/
https://hub.docker.com/_/httpd/

## installation

http://qiita.com/zembutsu/items/6fb6eface38d62b3584d


デモ用のnginxのコンテナを作成して、そこにアクセスすることで動きを確かめようと思う。

```
docker@manager:~$ docker service create --replicas 1 --name mynginx -p 80:80 zembutsu/docker-sample-nginx:1.0
3e1mm75jjpsjxayc21zn9zke7

docker@manager:~$ docker service ls
ID            NAME        REPLICAS  IMAGE                             COMMAND
3e1mm75jjpsj  mynginx     1/1       zembutsu/docker-sample-nginx:1.0  
9abu17y6p7af  helloworld  5/5       alpine                            ping docker.com

docker@manager:~$ docker service ps mynginx
ID                         NAME       IMAGE                             NODE     DESIRED STATE  CURRENT STATE          ERROR
60of9wn76pzsr3mzmryhf5xju  mynginx.1  zembutsu/docker-sample-nginx:1.0  worker2  Running        Running 2 minutes ago
```
worker2でコンテナが起動したことがわかる。
swarm modeではない場合はコンテナが実行されたホストの80/tcpポートにアクセスしなければnginxから応答を得ることはできないが、
swarm modeならmanagerの80/tcpポートにアクセスしてもworker2のnginxにルーティングされるはずである。
試してみる。

```
docker@manager:~$ telnet localhost 80
GET /
<html>
<body>
        <h1>Host: b73da4825610</h1>
</body>
</html>
Connection closed by foreign host
```
行けた！すばらしい。どうなっているんだ。

kubernetesもiptablesを使って実装していたが、dockerも同じらしい。
ingressという文字が見つかるのでingressはswarmに同梱されているもののようだ。


```
root@manager:~# iptables-save
# Generated by iptables-save v1.4.21 on Wed Jan 11 15:12:01 2017
*mangle
:PREROUTING ACCEPT [48179:71890942]
:INPUT ACCEPT [43799:71522592]
:FORWARD ACCEPT [4380:368350]
:OUTPUT ACCEPT [25105:2044752]
:POSTROUTING ACCEPT [29485:2413102]
COMMIT
# Completed on Wed Jan 11 15:12:01 2017
# Generated by iptables-save v1.4.21 on Wed Jan 11 15:12:01 2017
*nat
:PREROUTING ACCEPT [85:6999]
:INPUT ACCEPT [85:6999]
:OUTPUT ACCEPT [95:6358]
:POSTROUTING ACCEPT [95:6358]
:DOCKER - [0:0]
:DOCKER-INGRESS - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER-INGRESS
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT -m addrtype --dst-type LOCAL -j DOCKER-INGRESS
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -o docker_gwbridge -m addrtype --src-type LOCAL -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 ! -o docker_gwbridge -j MASQUERADE
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A DOCKER -i docker_gwbridge -j RETURN
-A DOCKER -i docker0 -j RETURN
-A DOCKER-INGRESS -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.18.0.2:80
-A DOCKER-INGRESS -j RETURN
COMMIT
# Completed on Wed Jan 11 15:12:01 2017
# Generated by iptables-save v1.4.21 on Wed Jan 11 15:12:01 2017
*filter
:INPUT ACCEPT [4524:431251]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4084:440751]
:DOCKER - [0:0]
:DOCKER-INGRESS - [0:0]
:DOCKER-ISOLATION - [0:0]
-A FORWARD -j DOCKER-INGRESS
-A FORWARD -j DOCKER-ISOLATION
-A FORWARD -o docker_gwbridge -j DOCKER
-A FORWARD -o docker_gwbridge -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker_gwbridge ! -o docker_gwbridge -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -i docker_gwbridge -o docker_gwbridge -j DROP
-A DOCKER-INGRESS -p tcp -m tcp --dport 80 -j ACCEPT
-A DOCKER-INGRESS -p tcp -m state --state RELATED,ESTABLISHED -m tcp --sport 80 -j ACCEPT
-A DOCKER-INGRESS -j RETURN
-A DOCKER-ISOLATION -i docker0 -o docker_gwbridge -j DROP
-A DOCKER-ISOLATION -i docker_gwbridge -o docker0 -j DROP
-A DOCKER-ISOLATION -j RETURN
COMMIT
# Completed on Wed Jan 11 15:12:01 2017
```

深入りするのはまた今度にする。
ingressは動いているようだけど、etcdが動いている形跡はない。
etcdはingressの動作には関係ないのだろうか。
